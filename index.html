<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>24 Game</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            text-align: center;
            background: linear-gradient(135deg, #4e73df, #1cc88a);
            color: white;
            padding-top: 40px;
        }

        h1 {
            font-size: 40px;
        }

        .start-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 80vh;
        }

        .start-screen button {
            font-size: 24px;
            margin: 20px;
            padding: 15px 40px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            background-color: #28a745;
            color: white;
            transition: background-color 0.3s;
        }

        .start-screen button:hover {
            background-color: #218838;
        }

        .start-screen .view-score-btn {
            background-color: #007bff;
            margin-top: 40px;
        }

        .start-screen .view-score-btn:hover {
            background-color: #0056b3;
        }

        .game-container {
            display: none;
            margin-top: 30px;
        }

        .game-container.active {
            display: block;
        }

        .timer-score {
            display: flex;
            justify-content: center;
            gap: 50px;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .timer {
            font-weight: bold;
            font-size: 24px;
        }

        .score {
            font-weight: bold;
            font-size: 24px;
        }

        .numbers button {
            font-size: 28px;
            margin: 10px;
            padding: 15px 20px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
        }

        .operators button {
            font-size: 22px;
            margin: 5px;
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
        }

        .controls button {
            margin: 10px;
            padding: 8px 15px;
            font-size: 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }

        .submit-button {
            background-color: #28a745;
            color: white;
            font-size: 18px;
            padding: 10px 20px;
            margin: 10px;
        }

        .submit-button:hover {
            background-color: #218838;
        }

        .exit-button {
            background-color: #dc3545;
            color: white;
            font-size: 18px;
            padding: 10px 20px;
            margin: 10px;
        }

        .exit-button:hover {
            background-color: #c82333;
        }

        .backspace-button {
            background-color: #ffc107;
            color: black;
            font-size: 18px;
            padding: 10px 20px;
            margin: 10px;
        }

        .backspace-button:hover {
            background-color: #e0a800;
        }

        .expression-box {
            margin-top: 20px;
            font-size: 24px;
            min-height: 40px;
        }

        .result {
            margin-top: 20px;
            font-size: 22px;
            font-weight: bold;
        }

        .feedback {
            margin-top: 15px;
            font-size: 20px;
            min-height: 30px;
            font-weight: bold;
        }

        .feedback.correct {
            color: #00ff00;
        }

        .feedback.incorrect {
            color: #ffcccc;
        }

        .hint {
            position: fixed;
            right: 30px;
            top: 30px;
            font-size: 30px;
            cursor: pointer;
        }

        .footer {
            position: fixed;
            bottom: 10px;
            left: 10px;
            font-size: 14px;
            opacity: 0.9;
        }

        .score-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
        }

        .score-modal.active {
            display: flex;
        }

        .score-content {
            background-color: #1cc88a;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            font-size: 32px;
            font-weight: bold;
        }

        .score-content button {
            margin-top: 30px;
            padding: 10px 30px;
            font-size: 18px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .score-content button:hover {
            background-color: #218838;
        }
    </style>
</head>

<body>

<div class="start-screen" id="startScreen">
    <h1>24 Game</h1>
    <button onclick="startGame()">Start Game</button>
    <button class="view-score-btn" onclick="viewScore()">View My Score</button>
</div>

<div class="score-modal" id="scoreModal">
    <div class="score-content">
        <div>Your Score: <span id="finalScore">0</span></div>
        <button onclick="closeScoreModal()">Close</button>
    </div>
</div>

<div class="game-container" id="gameContainer">

    <div class="hint" onclick="showHint()">ðŸ”‘</div>

    <div class="timer-score">
        <div class="timer">Time: <span id="timer">180</span>s</div>
        <div class="score">Score: <span id="score">0</span></div>
    </div>

    <div class="numbers" id="numbers"></div>

    <div class="operators">
        <button onclick="addOperator('+')">+</button>
        <button onclick="addOperator('-')">-</button>
        <button onclick="addOperator('*')">Ã—</button>
        <button onclick="addOperator('Ã·')">Ã·</button>
        <button onclick="addOperator('(')">(</button>
        <button onclick="addOperator(')')">)</button>
    </div>

    <div class="expression-box" id="expression"></div>

    <div class="controls">
        <button onclick="resetExpression()">Reset</button>
        <button onclick="newGame()">New Game</button>
        <button class="backspace-button" onclick="backspace()">Backspace</button>
        <button class="submit-button" onclick="checkAnswer()">Submit Answer</button>
        <button class="exit-button" onclick="exitGame()">Exit</button>
    </div>

    <div class="result" id="result"></div>
    <div class="feedback" id="feedback"></div>

</div>

<div class="footer">
    Author: XIA RUI DONG | Contact: xiarui091@gmail.com
</div>

<script>
    let numbers = [];
    let expression = "";
    let score = 0;
    let timeLeft = 180;
    let timerInterval = null;
    let gameActive = false;

    function startGame() {
        document.getElementById("startScreen").style.display = "none";
        document.getElementById("gameContainer").classList.add("active");
        score = 0;
        timeLeft = 180;
        gameActive = true;
        document.getElementById("score").innerText = score;
        newGame();
        startTimer();
    }

    function exitGame() {
        clearInterval(timerInterval);
        gameActive = false;
        document.getElementById("gameContainer").classList.remove("active");
        document.getElementById("startScreen").style.display = "flex";
    }

    function viewScore() {
        document.getElementById("finalScore").innerText = score;
        document.getElementById("scoreModal").classList.add("active");
    }

    function closeScoreModal() {
        document.getElementById("scoreModal").classList.remove("active");
    }

    function newGame() {
        expression = "";
        document.getElementById("expression").innerText = "";
        document.getElementById("feedback").innerText = "";
        numbers = generateSolvableNumbers();
        renderNumbers();
    }

    function generateSolvableNumbers() {
        while (true) {
            let arr = [];
            for (let i = 0; i < 4; i++) {
                arr.push(Math.floor(Math.random() * 9) + 1);
            }
            if (solve24(arr)) return arr;
        }
    }

    function renderNumbers() {
        const container = document.getElementById("numbers");
        container.innerHTML = "";
        numbers.forEach(num => {
            let btn = document.createElement("button");
            btn.innerText = num;
            btn.onclick = () => append(num);  // Ensure it calls append
            container.appendChild(btn);
        });
    }

    function append(value) {
        if (!gameActive) return;
        expression += value;
        document.getElementById("expression").innerText = expression;
    }

    function addOperator(op) {
        if (!gameActive) return;
        if (expression === "" && "+-*Ã·".includes(op)) return;
        let last = expression.slice(-1);
        if ("+-*Ã·".includes(last) && op !== '(' && op !== ')') return; // Prevent consecutive operators
        expression += op;
        document.getElementById("expression").innerText = expression;
    }

    function backspace() {
        expression = expression.slice(0, -1);
        document.getElementById("expression").innerText = expression;
    }

    function resetExpression() {
        expression = "";
        document.getElementById("expression").innerText = "";
        document.getElementById("feedback").innerText = "";
    }

    function calculateExpression(exp) {
        // Replace Ã· with / for calculation
        exp = exp.replace(/Ã·/g, '/');

        if (exp.includes("(")) {
            try {
                return eval(exp);
            } catch {
                return null;
            }
        }

        let tokens = [];
        let number = "";

        for (let char of exp) {
            if ("0123456789.".includes(char)) {
                number += char;
            } else if ("+-*/".includes(char)) {
                if (number === "") return null;
                tokens.push(parseFloat(number));
                tokens.push(char);
                number = "";
            } else {
                return null;
            }
        }

        if (number !== "") {
            tokens.push(parseFloat(number));
        }

        for (let i = 0; i < tokens.length; i++) {
            if (tokens[i] === "*" || tokens[i] === "/") {
                let a = tokens[i - 1];
                let b = tokens[i + 1];
                let result;

                if (tokens[i] === "*") {
                    result = a * b;
                } else {
                    if (b === 0) return null;
                    result = a / b;
                }

                tokens.splice(i - 1, 3, result);
                i -= 1;
            }
        }

        let result = tokens[0];
        for (let i = 1; i < tokens.length; i += 2) {
            if (tokens[i] === "+") {
                result += tokens[i + 1];
            } else if (tokens[i] === "-") {
                result -= tokens[i + 1];
            }
        }

        return result;
    }

    function checkAnswer() {
        if (!gameActive) return;
        let result = calculateExpression(expression);

        if (result === null) {
            document.getElementById("feedback").innerText = "Invalid Expression";
            document.getElementById("feedback").className = "feedback incorrect";
            return;
        }

        result = Math.round(result * 100) / 100;

        let feedbackEl = document.getElementById("feedback");
        
        if (result === 24) {
            score += 100;
            document.getElementById("score").innerText = score;
            feedbackEl.innerText = "Excellent! ðŸŽ‰";
            feedbackEl.className = "feedback correct";
            clearInterval(timerInterval);
            setTimeout(() => {
                timeLeft = 180;
                document.getElementById("timer").innerText = timeLeft;
                startTimer();
                newGame();
            }, 1500);
        } else {
            feedbackEl.innerText = "Sorry, that's incorrect. Try again!";
            feedbackEl.className = "feedback incorrect";
        }
    }

    function startTimer() {
        timerInterval = setInterval(() => {
            timeLeft--;
            document.getElementById("timer").innerText = timeLeft;

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                gameActive = false;
                let solution = solve24(numbers);
                document.getElementById("feedback").innerText = "Time's up! Game Over. Final Score: " + score + "\nCorrect Answer: " + solution;
                document.getElementById("feedback").className = "feedback";
            }
        }, 1000);
    }

    function solve24(nums, exprs = null) {
        if (!exprs) {
            exprs = nums.map(num => num.toString());
        }

        if (nums.length === 1) {
            if (Math.abs(nums[0] - 24) < 0.01) {
                return exprs[0];
            }
            return null;
        }

        for (let i = 0; i < nums.length; i++) {
            for (let j = 0; j < nums.length; j++) {
                if (i === j) continue;

                let newNums = [];
                let newExprs = [];

                for (let k = 0; k < nums.length; k++) {
                    if (k !== i && k !== j) {
                        newNums.push(nums[k]);
                        newExprs.push(exprs[k]);
                    }
                }

                let a = nums[i];
                let b = nums[j];
                let exprA = exprs[i];
                let exprB = exprs[j];

                let operations = [
                    { val: a + b, str: `(${exprA}+${exprB})` },
                    { val: a - b, str: `(${exprA}-${exprB})` },
                    { val: a * b, str: `(${exprA}*${exprB})` }
                ];

                if (b !== 0) {
                    operations.push({ val: a / b, str: `(${exprA}/${exprB})` });
                }

                for (let op of operations) {
                    let result = solve24(
                        [...newNums, op.val],
                        [...newExprs, op.str]
                    );

                    if (result) return result;
                }
            }
        }

        return null;
    }

    function showHint() {
        if (!gameActive) return;
        let solution = solve24(numbers);
        if (solution) {
            alert("Solution:\n" + solution);
        } else {
            alert("No solution found (this should not happen)");
        }
    }
</script>

</body>
</html>
